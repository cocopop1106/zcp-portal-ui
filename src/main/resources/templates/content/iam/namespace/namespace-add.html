<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity3" layout:decorator="layout/template-default">
<head>
	<title>CloudZ CP</title>
	<meta charset="UTF-8"/>
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
	<!-- <meta id="_csrf" name="_csrf" th:content="${_csrf.token}"/>
	<meta id="_csrf_header" name="_csrf_header" th:content="${_csrf.headerName}"/> -->
	<script th:inline="javascript" type="text/javascript">
	/*<![CDATA[*/
		function initNamespace(namespace){
			var url = "/iam/namespace/getNamespaceResource";
			ajaxCall(url, {"namespace" : namespace}).done(function(data){
				if(data.resourceQuota){
					$('#input_cpu_requests').val(data.resourceQuota.status.hard["requests.cpu"]);
					$('#input_cpu_limits').val(data.resourceQuota.status.hard["limits.memory"]);
					$('#input_memory_requests').val(data.resourceQuota.status.hard["requests.cpu"]);
					$('#input_memory_limits').val(data.resourceQuota.status.hard["limits.memory"]);
					$('#input_pods').val(data.resourceQuota.status.hard.pods);
					$('#input_services').val(data.resourceQuota.status.hard.services);
					$('#input_secrets').val(data.resourceQuota.status.hard.secrets);
					$('#input_config_maps').val(data.resourceQuota.status.hard.configmaps);
					$('#input_persistent_volume').val(data.resourceQuota.status.hard.persistentvolumeclaims);
					$('#input_service_load').val(data.resourceQuota.status.hard["services.loadbalancers"]);
				}
				if(data.limitRange){
					$('#input_pod_cpu_requests').val(	data.limitRange.spec.limits[0].defaultRequest.cpu.number);
					$('#input_pod_cpu_limits').val(		data.limitRange.spec.limits[0].default.cpu.number);
					$('#input_pod_memory_requests').val(data.limitRange.spec.limits[0].defaultRequest.memory.number);
					$('#input_pod_memory_limits').val(	data.limitRange.spec.limits[0].default.memory.number);
				}
				if(data.namespace){
					$('#input_namespace').val(data.namespace)
				}
			});
			
		}
	
		function ajaxCall(url, data){
			return $.ajax({
				method: 'post',
				contentType : 'application/json;charset=UTF-8',
				url: url,
				data: JSON.stringify(data)
	        }).fail(function(jqXHR, textStatus, errorThrown) {
	        	console.log(jqXHR);
	            //alert('처리 중 오류가 발생하였습니다. 잠시 후 다시 시도하세요.');
	        });
		}
		
		$(document).ready(function(){
			var namespace = /*[[${param.namespace}]]*/;
			if(namespace){
				$('#input_namespace').val(namespace);
				initNamespace(namespace[0]);	
			}
			
		});
		
		function addNamespace(){
			if(!validate()) return ;
			
			var data={
				resourceQuota : {
					spec :{
						hard : {
							"requests.cpu" : $('#input_cpu_requests').val() + ''
							,"limits.cpu" : $('#input_cpu_limits').val() + ''
							,"requests.memory" : $('#input_memory_requests').val() + ''
							,"limits.memory" : $('#input_memory_limits').val() + ''
							,"pods" : $('#input_pods').val() ? $('#input_pods').val() + '': "0" 
							,"secrets" : $('#input_secrets').val() ? $('#input_secrets').val()+ '' : "0"
							,"configmaps" : $('#input_config_maps').val() ? $('#input_config_maps').val()+ '' : "0"
							,"persistentvolumeclaims" : $('#input_persistent_volume').val() ? $('#input_persistent_volume').val()+ '' : "0"
							,"services.loadbalancers" : $('#input_persistent_service_load').val() ? $('#input_persistent_service_load').val()+ '' : "0"
						}
					}
				},
				limitRange : {
					spec : {
						limits : [{
							defaultRequest : {
								cpu : $('#input_pod_cpu_requests').val()
								,memory :  $('#input_pod_memory_requests').val()
							},
							default : {
								cpu :  $('#input_pod_cpu_limits').val()
								,memory : $('#input_pod_memory_limits').val()
							},
							type: "Container"
						}]
					}
				},
				namespace :  $('#input_namespace').val()
			};
			var url = "/iam/namespace/create";
			
			ajaxCall(url, data).done(function(data){
				alert('정상처리되었습니다.');
				location.href='/iam/namespace/namespace-list';
			});
		}
		
		function validate(){
			var regex_namespace = /^[a-zA-Z][0-9a-zA-z\-]{5,11}$/;
			if(!regex_namespace.test($('#input_namespace').val())){
				alert('허용하지 않는 문자입니다.');
				return false;
			}
			if(!$('#input_cpu_requests').val()) {
				$('#input_cpu_requests').focus();
				alert('필수값 입니다.');
				return false;
			}
			if(!$('#input_cpu_limits').val()) return false;
			if(!$('#input_memory_requests').val()) return false;
			if(!$('#input_memory_limits').val()) return false;
			if(!$('#input_pod_cpu_requests').val()) return false;
			if(!$('#input_pod_cpu_limits').val()) return false;
			if(!$('#input_pod_memory_requests').val()) return false;
			if(!$('#input_pod_memory_limits').val()) return false;
			return true;
		}
		
		
	 /*]]>*/
    </script>
</head>
<body>
<div class="cp-wrapper">
	<th:block layout:fragment="content">
	<!-- main-contents -->
	<div class="cp-container">
		<form>
		<!-- contents -->
		<div class="contents-wrap">
			<div class="locations-area">
				<th:block th:include="common/include/namespace :: common"></th:block>
			</div>
			<div class="contents-box">
				<!-- service top area-->
				<div class="top-area">
                    <h2 class="title">Namespace 추가</h2>
                    <div class="tag-wrap">
                    	<span class="tag">신규 namespace를 생성하고, namespace에서 사용할 Resource 정보를 설정합니다. </span>
                    	<a href="#" class="view-detail">자세히 보기</a>
                    </div>
				</div>
				<!-- namespace name -->
					<fieldset>
						<table class="Table Form-type topline">
							<colgroup>
								<col style="width: 200px;"/>
								<col/>
							</colgroup>
							<tbody>
								<tr>
									<th>Namespace 명<strong class="astertisk">*</strong></th>
									<td>
										<input class="Textinput Width-70" id="input_namespace" placeholder="알파벳과 숫자로 구성된 6~12자리로 입력하세요" />
										<p class="info-text">알파벳으로 시작하여 알파벳과 숫자로 구성된 6~12자리로 입력하세요.</p>
									</td>
								</tr>
							</tbody>
						</table>
					</fieldset>
				<!-- namespace name detail data-->
				<div class="lay-item__box">
					<!-- left table-->
					<div class="lay-item__left">
						<h3 class="form-title">Resource Quotas</h3>
							<fieldset>
								<table class="Table Form-type">
									<colgroup>
										<col style="width: 200px;"/>
										<col/>
									</colgroup>
									<tbody>
										<tr>
											<th>CPU Requests</th>
											<td>
												<input class="Textinput" id="input_cpu_requests"/>
												<div class="Divselect" style="width: 150px">
												    <select>
												        <option value="k">CPU(core)</option>
												        <option value="m">m(core)</option>
												    </select>
												    <span></span>
												</div>
											</td>
										</tr>
										<tr>
											<th>CPU Limits</th>
											<td>
												<input class="Textinput" id="input_cpu_limits"/>
												<div class="Divselect" style="width: 150px">
												    <select>
												        <option value="k">CPU(core)</option>
												        <option value="m">m(core)</option>
												    </select>
												    <span></span>
												</div>
											</td>
										</tr>
										<tr>
											<th>Memory Requests</th>
											<td>
												<input class="Textinput" id="input_memory_requests"/>
												<div class="Divselect" style="width: 150px">
												    <select>
												        <option value="Gi">Gi</option>
												        <option value="mi">mi</option>
												    </select>
												    <span></span>
												</div>
											</td>
										</tr>
										<tr>
											<th>Memory Limits</th>
											<td>
												<input class="Textinput" id="input_memory_limits"/>
												<div class="Divselect" style="width: 150px">
												    <select>
												        <option value="Gi">Gi</option>
												        <option value="mi">mi</option>
												    </select>
												    <span></span>
												</div>
											</td>
										</tr>
										<tr>
											<th>Pods</th>
											<td>
												<input class="Textinput" id="input_pods"/><span class="num-txt">개</span>
											</td>
										</tr>
										<tr>
											<th>Services</th>
											<td>
												<input class="Textinput" id="input_services"/><span class="num-txt">개</span>
											</td>
										</tr>
										<tr>
											<th>Secrets</th>
											<td>
												<input class="Textinput" id="input_secrets"/><span class="num-txt">개</span>
											</td>
										</tr>
										<tr>
											<th>Config Maps</th>
											<td>
												<input class="Textinput" id="input_config_maps"/><span class="num-txt">개</span>
											</td>
										</tr>
										<tr>
											<th>Persistent Volume<br/>Claims</th>
											<td>
												<input class="Textinput" id="input_pesistent_value"/><span class="num-txt">개</span>
											</td>
										</tr>
										<tr>
											<th>Service Load<br/>Balancers</th>
											<td>
												<input class="Textinput" id="input_service_load"/><span class="num-txt">개</span>
											</td>
										</tr>
									</tbody>
								</table>
							</fieldset>
					</div>
					<!--right table-->
					<div class="lay-item__right">
						<h3 class="form-title">Pod Default Limit Range</h3>
							<fieldset>
								<table class="Table Form-type">
									<colgroup>
										<col style="width: 200px;"/>
										<col/>
									</colgroup>
									<tbody>
										<tr>
											<th>CPU Requests</th>
											<td>
												<input class="Textinput" id="input_pod_cpu_requests"/>
												<div class="Divselect" style="width: 150px">
												    <select>
												        <option value="k">CPU(core)</option>
												        <option value="m">m(core)</option>
												    </select>
												    <span></span>
												</div>
											</td>
										</tr>
										<tr>
											<th>CPU Limits</th>
											<td>
												<input class="Textinput" id="input_pod_cpu_limits"/>
												<div class="Divselect" style="width: 150px">
												    <select>
												        <option value="k">CPU(core)</option>
												        <option value="m">m(core)</option>
												    </select>
												    <span></span>
												</div>
											</td>
										</tr>
										<tr>
											<th>Memory Requests</th>
											<td>
												<input class="Textinput" id="input_pod_memory_requests"/>
												<div class="Divselect" style="width: 150px">
												    <select>
												        <option value="Gi">Gi</option>
												        <option value="mi">mi</option>
												    </select>
												    <span></span>
												</div>
											</td>
										</tr>
										<tr>
											<!-- th의 style height: 410px;은 psd 상의 디자인을 맞추기 위한 것입니다. 참고하세요.-->
											<th class="Valign-top" style="height: 410px;">Memory Limits</th> 
											<td class="Valign-top">
												<input class="Textinput" id="input_pod_memory_limits"/>
												<div class="Divselect" style="width: 150px">
												    <select>
												        <option value="Gi">Gi</option>
												        <option value="mi">mi</option>
												    </select>
												    <span></span>
												</div>
											</td>
										</tr>
									</tbody>
								</table>
							</fieldset>
					</div>
				</div>
				<!-- button wrap-->
				<div class="btn-wrap">
					<div class="btn-left"><button class="Button btn">취소</button></div>
					<div class="btn-right"><button class="Button btn bg-red" onclick="addNamespace();">확인</button></div>
		        </div>
			</div>
		</div>
		</form>
		<!-- //contents -->
	</div>
	<!-- //main-contents -->
	</th:block>
</div>
</body>
</html>
